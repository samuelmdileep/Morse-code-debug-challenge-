<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Round 3 | Hidden Morse</title>
  <link rel="icon" type="image/png" href="hackher 1.png">

  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --purple:#8B6AAF;
      --pink:#D4789C;
      --text:#6A5A7A;
      --border:#DBCDF0;
      --green:#5A8A7A;
      --bg1:#FDFCFA; --bg2:#FAEDCB; --bg3:#F2C6DE; --bg4:#DBCDF0; --bg5:#C6DEF1;
    }

    body{
      margin:0;
      font-family:"Space Mono",monospace;
      background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4),var(--bg5));
      color:var(--text);
      overflow-x:hidden;
    }

    .hackher-header{
      position:fixed; top:0; left:0; right:0;
      height:72px; padding:0 32px;
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(253,252,250,.9);
      backdrop-filter:blur(10px);
      border-bottom:2px solid var(--border);
      z-index:100;
    }
    .nav-left img{height:48px}

    main{
      max-width:700px;
      margin:0 auto;
      padding:120px 20px;
    }

    .round-box{
      padding:30px;
      background:rgba(255,255,255,0.65);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
    }

    h2{
      color:var(--purple);
      font-size:30px;
      text-align:center;
      margin-bottom:12px;
    }

    .timer-bar{
      text-align:center;
      font-size:20px;
      font-weight:700;
      color:var(--purple);
      margin-bottom:20px;
    }

    .morse-image{
      width:100%;
      border-radius:10px;
      margin:15px 0 25px 0;
      border:2px solid var(--border);
      cursor:pointer;
    }

    .answer-input{
      width:100%;
      padding:14px;
      border-radius:10px;
      border:2px solid var(--border);
      font-family:"Space Mono",monospace;
      font-size:18px;
      outline:none;
      text-transform:uppercase;
      margin-top:20px;
    }

    .submit-btn{
      width:100%;
      padding:14px;
      margin-top:25px;
      border:2px solid #000;
      background:#fff;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
      font-weight:700;
    }
    .submit-btn:hover{
      background:#000; color:#fff;
    }

    /* ---------------- ZOOM MODAL ---------------- */
    #zoomModal{
      display:none;
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      backdrop-filter:blur(6px);
      z-index:9999;
      justify-content:center;
      align-items:center;
    }

    #zoomImg{
      max-width:90%;
      max-height:90%;
      border-radius:14px;
      transition:transform 0.2s ease;
      cursor:grab;
    }

  </style>
</head>

<body>

<header class="hackher-header">
  <div class="nav-left">
    <img src="hackher 1.png" alt="HackHER Logo">
  </div>
</header>


<main>
<div class="timer-bar">
  ⏱ <span id="timer">00:00</span>
</div>


  <div class="round-box">

    <h2>$ Round 3 – Hidden Image Morse</h2>

    <p>Observe the image carefully and type the decoded word.</p>

    <!-- HIDDEN MORSE IMAGE -->
    <img src="3rdround.jpg" class="morse-image" alt="Hidden Morse Image">

    <!-- FULLSCREEN ZOOM VIEW -->
    <div id="zoomModal">
      <img id="zoomImg" src="3rdround.jpg">
    </div>

    <!-- TYPING INPUT -->
    <input id="answerInput" class="answer-input" placeholder="TYPE YOUR ANSWER…" />

    <button id="submitBtn" class="submit-btn">SUBMIT →</button>

  </div>

</main>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from 
    "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { doc, setDoc, getDoc } from 
    "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  let userUID = null;

  /* ---------------- ANTI REFRESH / BACK / CLOSE ---------------- */

  function blockUnload(e){
    e.preventDefault();
    e.returnValue = "";
  }
  window.addEventListener("beforeunload", blockUnload);

  document.addEventListener("keydown",(e)=>{
    if(e.key==="F5" || (e.ctrlKey&&e.key==="r")){
      e.preventDefault(); alert("Refreshing is not allowed!");
    }
  });

  history.pushState(null,null,location.href);
  window.onpopstate = () => { history.go(1); alert("Back navigation disabled!"); };


  /* ---------------- PREVENT RESTART ---------------- */

  onAuthStateChanged(auth, async(user)=>{
    if(!user){ location.href="login.html"; return; }

    userUID = user.uid;

    const snap = await getDoc(doc(db,"scores",userUID));

    if (snap.exists() && snap.data().level3?.started){
      alert("Round 3 already started!");
      window.removeEventListener("beforeunload", blockUnload);
      location.href="round4.html";
      return;
    }

    await setDoc(doc(db,"scores",userUID),{
      level3:{ started: Date.now() }
    },{ merge:true });
  });


  /* ---------------- TIMER ---------------- */

  let sec=0;  
  let interval = setInterval(()=>{
    sec++;
    timer.innerText =
      `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
  },1000);

  function stopTimer(){ clearInterval(interval); return sec; }


/* ---------------- TRUE PAN + ZOOM ---------------- */

const smallImg = document.querySelector(".morse-image");
const zoomModal = document.getElementById("zoomModal");
const zoomImg = document.getElementById("zoomImg");

let scale = 1;
let isPanning = false;
let startX = 0, startY = 0;
let moveX = 0, moveY = 0;

/* OPEN MODAL */
smallImg.onclick = () => {
  zoomModal.style.display = "flex";
  scale = 1;
  moveX = moveY = 0;
  zoomImg.style.transform = "translate(0px, 0px) scale(1)";
  zoomImg.style.cursor = "default";
};

/* CLOSE MODAL */
zoomModal.onclick = (e) => {
  if (e.target !== zoomImg) {
    zoomModal.style.display = "none";
    scale = 1;
    moveX = moveY = 0;
    zoomImg.style.transform = "translate(0,0) scale(1)";
  }
};

/* SCROLL ZOOM */
zoomImg.addEventListener("wheel", (e) => {
  e.preventDefault();

  let oldScale = scale;
  scale += (e.deltaY < 0 ? 0.1 : -0.1);
  scale = Math.min(Math.max(scale, 1), 4);

  if (scale === 1) {
    moveX = moveY = 0;
    zoomImg.style.cursor = "default";
  } else {
    zoomImg.style.cursor = "grab";
  }

  zoomImg.style.transform = `translate(${moveX}px, ${moveY}px) scale(${scale})`;
});

/* PAN (Desktop) */
zoomImg.addEventListener("mousedown", (e) => {
  if (scale === 1) return;
  isPanning = true;
  zoomImg.style.cursor = "grabbing";
  startX = e.clientX - moveX;
  startY = e.clientY - moveY;
});

window.addEventListener("mousemove", (e) => {
  if (!isPanning || scale === 1) return;

  moveX = e.clientX - startX;
  moveY = e.clientY - startY;

  zoomImg.style.transform = `translate(${moveX}px, ${moveY}px) scale(${scale})`;
});

window.addEventListener("mouseup", () => {
  if (scale > 1) zoomImg.style.cursor = "grab";
  isPanning = false;
});

/* Touch Pan + Pinch */
let initialDist = 0;

zoomImg.addEventListener("touchstart", (e) => {
  if (e.touches.length === 1 && scale > 1) {
    isPanning = true;
    startX = e.touches[0].clientX - moveX;
    startY = e.touches[0].clientY - moveY;
  }
});

zoomImg.addEventListener("touchmove", (e) => {
  e.preventDefault();

  if (e.touches.length === 2) {
    const dx = e.touches[0].clientX - e.touches[1].clientX;
    const dy = e.touches[0].clientY - e.touches[1].clientY;
    const dist = Math.sqrt(dx*dx + dy*dy);

    if (!initialDist) initialDist = dist;

    scale += (dist - initialDist) / 250;
    scale = Math.min(Math.max(scale, 1), 4);

    if (scale === 1) {
      moveX = moveY = 0;
      zoomImg.style.cursor = "default";
    } else {
      zoomImg.style.cursor = "grab";
    }

    initialDist = dist;
  }

  if (e.touches.length === 1 && isPanning && scale > 1) {
    moveX = e.touches[0].clientX - startX;
    moveY = e.touches[0].clientY - startY;
  }

  zoomImg.style.transform = `translate(${moveX}px, ${moveY}px) scale(${scale})`;
});

zoomImg.addEventListener("touchend", () => {
  isPanning = false;
  initialDist = 0;
});


/* ---------------- SUBMIT ---------------- */

submitBtn.onclick = async()=>{
  const typed = answerInput.value.trim().toUpperCase();
  if (!typed){
    alert("Type your decoded answer!");
    return;
  }

  const correct = "SHE";
  const totalTime = stopTimer();

  await setDoc(doc(db,"scores",userUID),{
    level3:{
      typed: typed,
      correct:(typed===correct),
      score:(typed===correct?1:0),
      timeTaken: totalTime,
      submittedAt: Date.now()
    }
  },{ merge:true });

  window.removeEventListener("beforeunload", blockUnload);

  // ALWAYS GO NEXT ROUND
  location.href = "round4.html";
};

</script>

</body>
</html>
