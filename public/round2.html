<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>Round 2 | Audio Morse</title>
  <link rel="icon" type="image/png" href="hackher 1.png">

  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --purple:#8B6AAF;
      --pink:#D4789C;
      --text:#6A5A7A;
      --border:#DBCDF0;
      --green:#5A8A7A;
      --bg1:#FDFCFA; --bg2:#FAEDCB; --bg3:#F2C6DE; --bg4:#DBCDF0; --bg5:#C6DEF1;
    }

    body{
      margin:0;
      font-family:"Space Mono",monospace;
      background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4),var(--bg5));
      color:var(--text);
      overflow-x:hidden;
    }

    .hackher-header{
      position:fixed; top:0; left:0; right:0;
      height:72px; padding:0 32px;
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(253,252,250,.9);
      backdrop-filter:blur(12px);
      border-bottom:2px solid var(--border);
      z-index:100;
    }
    .nav-left img{height:48px}

    main{
      max-width:700px;
      margin:0 auto;
      padding:120px 20px;
    }

    .round-box{
      padding:32px;
      background:rgba(255,255,255,0.65);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 28px rgba(0,0,0,0.06);
    }

    h2{
      text-align:center;
      color:var(--purple);
      font-size:32px;
      margin-bottom:14px;
      font-weight:700;
    }

    .timer-bar{
      text-align:center;
      font-size:20px;
      font-weight:700;
      color:var(--purple);
      margin-bottom:28px;
    }

    .play-btn{
      width:100%;
      padding:16px;
      margin-top:12px;
      border:2.5px solid var(--purple);
      background:#fff;
      color:var(--purple);
      font-weight:700;
      border-radius:12px;
      cursor:pointer;
      transition:.2s;
      font-size:18px;
    }
    .play-btn:hover{
      background:var(--purple); color:#fff;
    }

.answer-input {
  width: 100%;
  padding: 14px 16px;
  margin-top: 20px;
  border-radius: 10px;
  border: 2px solid var(--purple);
  background: #fff;

  box-sizing: border-box;   /* <-- FIXES overflow */

  font-family: "Space Mono", monospace;
  font-size: 18px;
  font-weight: 600;
  color: var(--text);
  outline: none;
  text-transform: uppercase;

  transition: 0.2s;
}
.answer-input:focus {
  border-color: var(--pink);
  box-shadow: 0 0 0 3px rgba(212,120,156,0.25);
}


    .submit-btn{
      width:100%;
      padding:16px;
      margin-top:26px;
      border:2.5px solid #000;
      background:#fff;
      border-radius:12px;
      cursor:pointer;
      font-size:20px;
      font-weight:700;
      transition:.2s;
    }
    .submit-btn:hover{
      background:#000; color:#fff;
    }
  </style>
</head>

<body>

<header class="hackher-header">
  <div class="nav-left">
    <img src="hackher 1.png" alt="HackHER Logo">
  </div>
</header>

<main>

  <div class="timer-bar">⏱ <span id="timer">00:00</span></div>

  <div class="round-box">
    <h2>$ Round 2 – Audio Morse</h2>

    <p style="font-size:17px; line-height:1.5; text-align:center;">
      Listen to the Morse code and type the decoded word below.
    </p>

    <!-- AUDIO -->
    <audio id="morseAudio" src="audio/power.mp3"></audio>

    <button id="playBtn" class="play-btn">▶ PLAY AUDIO</button>

    <!-- USER INPUT -->
    <input type="text" id="answerInput" class="answer-input" placeholder="TYPE YOUR ANSWER (eg : TOWER)" />

    <button id="submitBtn" class="submit-btn">SUBMIT →</button>
  </div>

</main>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  let userUID = null;

  /* ---- Anti refresh / back ---- */
  function blockUnload(e){ e.preventDefault(); e.returnValue=""; }
  window.addEventListener("beforeunload", blockUnload);

  document.addEventListener("keydown",(e)=>{
    if(e.key==="F5" || (e.ctrlKey&&e.key==="r")){ e.preventDefault(); alert("Refreshing is not allowed!"); }
  });

  history.pushState(null,null,location.href);
  window.onpopstate = ()=>{ history.go(1); alert("Back navigation is disabled!"); };

  /* ---- Prevent restart ---- */
  onAuthStateChanged(auth, async(user)=>{
    if(!user){ location.href="login.html"; return; }

    userUID = user.uid;

    const snap = await getDoc(doc(db,"scores",userUID));
    if (snap.exists() && snap.data().level2?.started){
      window.removeEventListener("beforeunload", blockUnload);
      location.href="round3.html";
      return;
    }

    await setDoc(doc(db,"scores",userUID),{ level2:{ started: Date.now() } },{ merge:true });
  });

  /* ---- Timer ---- */
  let sec=0;
  let interval=setInterval(()=>{
    sec++;
    timer.innerText = `${String(Math.floor(sec/60)).padStart(2,'0')}:${String(sec%60).padStart(2,'0')}`;
  },1000);

  function stopTimer(){ clearInterval(interval); return sec; }

  /* ---- Audio ---- */
  let isLocked = false;
  const audio = document.getElementById("morseAudio");

  audio.addEventListener("ended", () => {
    isLocked = false;
    playBtn.innerText = "▶ PLAY AGAIN";
    playBtn.style.opacity = "1";
  });

  playBtn.onclick = () => {
    if (isLocked) return alert("Replay after audio finishes!");

    isLocked = true;
    audio.pause();
    audio.currentTime = 0;

    audio.play().then(()=>{
      playBtn.innerText = "▶ PLAYING...";
      playBtn.style.opacity = "0.6";
    });
  };

  /* ---- Submit ---- */
  submitBtn.onclick = async()=>{
    const typed = answerInput.value.trim().toUpperCase();
    if (!typed){ alert("Enter your decoded answer!"); return; }

    const correct = "POWER";
    const totalTime = stopTimer();

    await setDoc(doc(db,"scores",userUID),{
      level2:{
        typed, correct:(typed===correct),
        score:(typed===correct?1:0),
        timeTaken:totalTime,
        submittedAt:Date.now()
      }
    },{ merge:true });

    window.removeEventListener("beforeunload", blockUnload);
    location.href = "round3.html";
  };
</script>

<!-- Mobile unlock -->
<script>
document.addEventListener("touchstart", () => {
  const a = document.getElementById("morseAudio");
  if (a) {
    a.muted = false;
    a.play().catch(()=>{});
    a.pause();
    a.currentTime = 0;
  }
}, { once:true });
</script>

</body>
</html>
