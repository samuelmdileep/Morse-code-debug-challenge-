<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <title>Round 1 | Morse Logic</title>
  <link rel="icon" type="image/png" href="hackher 1.png">

  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --purple:#8B6AAF;
      --pink:#D4789C;
      --text:#6A5A7A;
      --border:#DBCDF0;
      --green:#5A8A7A;
      --bg1:#FDFCFA; --bg2:#FAEDCB; --bg3:#F2C6DE; --bg4:#DBCDF0; --bg5:#C6DEF1;
    }

    body{
      margin:0;
      font-family:"Space Mono",monospace;
      background:linear-gradient(180deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4),var(--bg5));
      color:var(--text);
      overflow-x:hidden;
    }

    .hackher-header{
      position:fixed;
      top:0; left:0; right:0;
      height:72px; padding:0 32px;
      display:flex; align-items:center; justify-content:space-between;
      background:rgba(253,252,250,.9);
      backdrop-filter:blur(12px);
      border-bottom:2px solid var(--border);
      z-index:100;
    }
    .nav-left img{height:48px}

    main{
      max-width:700px;
      margin:0 auto;
      padding:120px 20px;
      text-align:center;
    }

    .round-box{
      padding:30px;
      background:rgba(255,255,255,0.65);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 10px 25px rgba(0,0,0,0.05);
      text-align:left;
    }

    h2{
      color:var(--purple);
      text-align:center;
      font-size:30px;
      margin-bottom:12px;
    }

    .timer-bar{
      width:100%;
      text-align:center;
      font-size:20px;
      font-weight:700;
      color:var(--purple);
      margin-bottom:20px;
    }

    .option{
      padding:14px 16px;
      background:#fff;
      border:2px solid var(--border);
      border-radius:10px;
      margin-top:14px;
      cursor:pointer;
      transition:.2s;
      font-size:16px;
    }
    .option:hover{
      border-color:var(--purple);
      color:var(--purple);
    }

    .selected{
      border-color:var(--purple) !important;
      background:rgba(139,106,175,0.12);
      color:var(--purple);
    }

    .submit-btn{
      width:100%;
      padding:14px;
      margin-top:22px;
      border:2px solid #000;
      background:#fff;
      border-radius:10px;
      cursor:pointer;
      font-size:18px;
      font-weight:700;
      transition:.2s ease;
    }

    .submit-btn:hover{
      background:#000;
      color:#fff;
    }
  </style>
</head>

<body>

<header class="hackher-header">
  <div class="nav-left">
    <img src="hackher 1.png" alt="HackHER Logo">
  </div>
</header>

<main>

  <div class="timer-bar">
    ⏱ <span id="timer">00:00</span>
  </div>

  <div class="round-box">
    <h2>$ Round 1 – Morse Logic</h2>

    <p><strong>Decode the Morse code and choose the correct option.</strong></p>
    <p>The target word is <strong>“LOGIC”</strong>.</p>

    <div class="option" data-value="A">A) .-.. --- --. .- -.-.</div>
    <div class="option" data-value="B">B) .-.. --- -. .. -.-.</div>
    <div class="option" data-value="C">C) .-.. --- --. .. -.-.</div>
    <div class="option" data-value="D">D) .-.. --- --. .. -.-.</div>

    <button id="submitBtn" class="submit-btn">SUBMIT →</button>
  </div>

</main>

<script type="module">
  import { auth, db } from "./firebase.js";
  import { onAuthStateChanged } from 
    "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
  import { doc, setDoc, getDoc } from 
    "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

  let userUID = null;
  let selectedOption = null;

  // ---------------- ANTI-REFRESH BLOCK LOGIC ----------------
  function blockUnload(e){
    e.preventDefault();
    e.returnValue = "";
  }

  window.addEventListener("beforeunload", blockUnload);

  document.addEventListener("keydown", (e)=>{
    if (e.key === "F5" || (e.ctrlKey && e.key === "r") || (e.metaKey && e.key === "r")){
      e.preventDefault();
      alert("Refreshing is not allowed!");
    }
  });

  history.pushState(null, null, location.href);
  window.onpopstate = function () {
    history.go(1);
    alert("Back navigation is disabled!");
  };
  // -----------------------------------------------------------


  // AUTH + ANTI-RESTART
  onAuthStateChanged(auth, async (user)=>{
    if(!user){ window.location.href="login.html"; return; }
    userUID = user.uid;

    const snap = await getDoc(doc(db, "scores", userUID));

    // If already started earlier
    if (snap.exists() && snap.data().level1?.started){
      alert("Round 1 already started. You cannot restart.");
      window.onbeforeunload = null;
      window.location.href="round2.html";
      return;
    }

    // First time only
    await setDoc(doc(db,"scores",userUID),{
      level1:{ started: Date.now() }
    },{ merge:true });
  });


  // ---------------- TIMER ----------------
  let seconds = 0;
  let interval = setInterval(()=>{
    seconds++;
    let mins = String(Math.floor(seconds/60)).padStart(2,"0");
    let secs = String(seconds % 60).padStart(2,"0");
    document.getElementById("timer").innerText = `${mins}:${secs}`;
  },1000);
  function stopTimer(){ clearInterval(interval); return seconds; }
  // ------------------------------------------------------------


  // OPTION SELECT
  document.querySelectorAll(".option").forEach(opt=>{
    opt.addEventListener("click",()=>{
      document.querySelectorAll(".option").forEach(o=>o.classList.remove("selected"));
      opt.classList.add("selected");
      selectedOption = opt.dataset.value;
    });
  });


  // SUBMIT BUTTON
  submitBtn.onclick = async () => {
    if(!selectedOption){
      alert("Select an option first!");
      return;
    }

    const correct = "D";
    const totalTime = stopTimer();

    await setDoc(
      doc(db,"scores",userUID),
      {
        level1:{
          selected: selectedOption,
          correct: (selectedOption === correct),
          score: (selectedOption === correct ? 1 : 0),
          timeTaken: totalTime,
          submittedAt: Date.now()
        }
      },
      { merge:true }
    );

    // ❗ Remove unload block before redirect
    window.removeEventListener("beforeunload", blockUnload);

    if(selectedOption === correct){
      window.location.href = "round2.html";
    } else {
      alert("Incorrect answer. Try again!");
    }
  };

</script>

</body>
</html>

